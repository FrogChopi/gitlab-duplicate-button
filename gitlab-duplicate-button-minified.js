// ==UserScript==
// @name         gitlab duplicate button
// @description  a simply tool to rapidly duplicate pipeline schedule
// @match        https://gitlab.com/*/pipeline_schedules*
// @match        https://*.gitlab.com/*/pipeline_schedules*
// @grant        GM_log
// @run-at       document-end
// @author       FrogChopi
// @version      1
// @downloadURL  https://github.com/FrogChopi/gitlab-duplicate-button/blob/main/gitlab-duplicate-button.js
// ==/UserScript==

!async function(){"use strict";var e;await(e='a[data-testid="edit-pipeline-schedule-btn"]',new Promise((n=>{if(document.querySelector(e))return n(document.querySelector(e));const t=new MutationObserver((a=>{document.querySelector(e)&&(n(document.querySelector(e)),t.disconnect())}));t.observe(document.body,{childList:!0,subtree:!0})}))),document.querySelectorAll('a[data-testid="edit-pipeline-schedule-btn"]').forEach((e=>{let n=e.href.match(/(\d+)$/)[1],t={operationName:"getPipelineSchedulesQuery",variables:{ids:[n],prevPageCursor:"",nextPageCursor:"",projectPath:window.location.pathname.match(/^(.+)\/-\/pipeline_schedules/)[1]},query:'query getPipelineSchedulesQuery($projectPath: ID!, $status: PipelineScheduleStatus, $ids: [ID!] = null, $sortValue: PipelineScheduleSort, $first: Int, $last: Int, $prevPageCursor: String = "", $nextPageCursor: String = "") {\n  currentUser {\n    id\n    username\n    __typename\n  }\n  project(fullPath: $projectPath) {\n    id\n    projectPlanLimits {\n      ciPipelineSchedules\n      __typename\n    }\n    pipelineSchedules(\n      status: $status\n      ids: $ids\n      sort: $sortValue\n      first: $first\n      last: $last\n      after: $nextPageCursor\n      before: $prevPageCursor\n    ) {\n      count\n      nodes {\n        id\n        description\n        cron\n        cronTimezone\n        ref\n        forTag\n        editPath\n        refPath\n        refForDisplay\n        lastPipeline {\n          id\n          detailedStatus {\n            id\n            group\n            icon\n            label\n            text\n            detailsPath\n            __typename\n          }\n          __typename\n        }\n        active\n        nextRunAt\n        realNextRun\n        owner {\n          id\n          username\n          avatarUrl\n          name\n          webPath\n          __typename\n        }\n        variables {\n          nodes {\n            id\n            variableType\n            key\n            value\n            __typename\n          }\n          __typename\n        }\n        userPermissions {\n          playPipelineSchedule\n          updatePipelineSchedule\n          adminPipelineSchedule\n          __typename\n        }\n        __typename\n      }\n      pageInfo {\n        ...PageInfo\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n}\n\nfragment PageInfo on PageInfo {\n  hasNextPage\n  hasPreviousPage\n  startCursor\n  endCursor\n  __typename\n}\n'};var a=document.createElement("BUTTON"),l=document.createElement("IMG");a.className="btn btn-default btn-md gl-button btn-icon",l.className="gl-button-icon gl-icon s16 gl-fill-current",l.src="https://cdn-icons-png.flaticon.com/512/1621/1621635.png",a.appendChild(l),a.id=n,a.title="Duplicate scheduled pipeline",a.ariaLabel="Duplicate scheduled pipeline",a.onclick=async()=>{let e=await async function(e){return new Promise(((t,a)=>{let l=document.location.host;JSON.stringify(e),fetch(`https://${l}/api/v4/projects/${+document.body.getAttribute("data-project-id")}/pipeline_schedules/${n}`,{method:"GET",credentials:"include",headers:{Accept:"application/json"}}).then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()})).then((e=>{console.log("Succès:",e),t(e)})).catch((e=>{console.error("Erreur:",e),a(e)}))}))}(t),a=document.createElement("DIV");a.innerHTML=`\n                  <div id="delete-pipeline-schedule-modal___BV_modal_outer_" style="position: absolute; z-index: 1040;">\n                        <div id="delete-pipeline-schedule-modal" role="dialog" aria-label="Delete scheduled pipeline" aria-describedby="delete-pipeline-schedule-modal___BV_modal_body_" class="modal fade show gl-block gl-modal" aria-modal="true" style="">\n                              <div class="modal-dialog modal-sm">\n                                    <span tabindex="0"></span>\n                                    <div id="delete-pipeline-schedule-modal___BV_modal_content_" tabindex="-1" class="modal-content">\n                                          <header id="delete-pipeline-schedule-modal___BV_modal_header_" class="modal-header">\n                                                <h2 class="modal-title">Delete scheduled pipeline</h2>\n                                                <button aria-label="Close" type="button" class="btn btn-default btn-sm gl-button btn-default-tertiary btn-icon">\n                                                      \x3c!----\x3e\n                                                      <svg data-testid="close-icon" role="img" aria-hidden="true" class="gl-button-icon gl-icon s16 gl-fill-current">\n                                                            <use href="/assets/icons-8791a66659d025e0a4c801978c79a1fbd82db1d27d85f044a35728ea7cf0ae80.svg#close"></use>\n                                                      </svg>\n                                                      \x3c!----\x3e\n                                                </button>\n                                          </header>\n                                          <div id="delete-pipeline-schedule-modal___BV_modal_body_" class="modal-body">\n                                                \x3c!----\x3e\n                                                <h5>New schedule name</h5>\n                                                <div class="input-group mb-3">\n                                                      <div class="input-group-prepend">\n                                                            <span class="input-group-text" id="basic-addon1">@</span>\n                                                      </div>\n                                                      <input type="text" class="form-control" placeholder="New schedule name" aria-label="New schedule name" aria-describedby="basic-addon1" value="${e.description}">\n                                                </div>\n                                                \x3c!----\x3e\n                                                <h6>Are you sure you want to duplicate this scheduled pipeline?</h6>\n                                                \x3c!----\x3e\n                                          </div>\n                                          <footer id="delete-pipeline-schedule-modal___BV_modal_footer_" class="modal-footer">\n                                                <button aria-label="Cancel" type="button" class="btn js-modal-action-cancel btn-default btn-md gl-button">\n                                                      \x3c!----\x3e\n                                                      \x3c!----\x3e\n                                                      <span class="gl-button-text">\n                                                      Cancel\n                                                      </span>\n                                                </button>\n                                                \x3c!----\x3e\n                                                <button aria-label="Duplicate" type="button" class="btn js-modal-action-primary btn-warning btn-md gl-button">\n                                                      \x3c!----\x3e\n                                                      \x3c!----\x3e\n                                                      <span class="gl-button-text">\n                                                            Duplicate scheduled pipeline\n                                                      </span>\n                                                </button>\n                                          </footer>\n                                    </div>\n                                    <span tabindex="0"></span>\n                              </div>\n                        </div>\n                        <div id="delete-pipeline-schedule-modal___BV_modal_backdrop_" class="modal-backdrop"></div>\n                  </div>\n            `,a.querySelector('button[aria-label="Close"]').onclick=()=>a.remove(),a.querySelector('button[aria-label="Cancel"]').onclick=()=>a.remove(),a.querySelector('button[aria-label="Duplicate"]').onclick=async()=>{a.querySelector('input[aria-label="New schedule name"]').value==e.description?alert("The new schedule name can't be the same !"):(await async function(e,n,t,a){return new Promise(((l,i)=>{const o=`/api/v4/projects/${document.body.getAttribute("data-project-id")}/pipeline_schedules`,d={description:e,ref:n,cron:t,cron_timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,active:!1,variables:a};return fetch(o,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":document.querySelector('meta[name="csrf-token"]').content},credentials:"same-origin",body:JSON.stringify(d)}).then((e=>{l(e)})).catch((e=>{i(e)}))}))}(a.querySelector('input[aria-label="New schedule name"]').value,e.ref,e.cron,e.variables),window.location.reload())},document.body.appendChild(a)},e.parentNode.insertBefore(a,e.parentNode.lastChild)}))}();